---
- name: Install required system packages
  apt:
    name:
      - bash
      - debootstrap
      - gzip
      - tar
    state: present
    update_cache: true

- name: Get list of ubuntu mirrors
  uri:
    url: http://mirrors.ubuntu.com/mirrors.txt
    body_format: raw
    return_content: true
  register: uri_mirrors

- name: Ensure /var/lib/machines directory exists
  file:
    path: /var/lib/machines/
    state: directory
    owner: root
    group: root
    mode: u=rwx,go=

- name: Deboostrap ubuntu chroot filesystems
  shell: |
    set -o errexit

    debootstrap \
      --arch amd64 \
      --components=main,restricted,universe \
      --include={{ _include }} \
      {{ item }} {{ _destdir }}/ {{ uri_mirrors.content.splitlines() | first | trim }}

    install -o 0 -g 0 -m u=rw,go=r /dev/fd/0 {{ _destdir }}/etc/apt/sources.list <<'EOF'
    deb mirror://mirrors.ubuntu.com/mirrors.txt {{ item }}         main restricted universe
    deb mirror://mirrors.ubuntu.com/mirrors.txt {{ item }}-updates main restricted
    EOF

    chroot {{ _destdir }}/ /bin/env -i bash --noprofile --norc -s <<'EOF'
      set -o errexit
      export DEBIAN_FRONTEND=noninteractive
      apt-get -y update
      apt-get -y upgrade
      apt-get -y clean
    EOF

    install -o 0 -g 0 -m u=rwx,go=r /dev/fd/0 {{ _destdir }}/etc/rc.local <<'EOF'
    #!/usr/bin/env sh
    set -e
    if ! [ -e /dev/mem ]; then
        mknod -m 660 /dev/mem c 1 1
        chown root:kmem /dev/mem
    fi
    EOF

    install -o 0 -g 0 -m u=rwx,go=rx -d {{ _destdir }}/etc/systemd/system/rc-local.service.d/
    install -o 0 -g 0 -m u=rw,go=r /dev/fd/0 {{ _destdir }}/etc/systemd/system/rc-local.service.d/override.conf <<'EOF'
    [Install]
    WantedBy=multi-user.target
    EOF

    ln -s \
      /etc/systemd/system/rc-local.service \
      {{ _destdir }}/etc/systemd/system/multi-user.target.wants/rc-local.service

    mountpoint -q {{ _destdir }}/proc/ && umount {{ _destdir }}/proc/
    mountpoint -q {{ _destdir }}/sys/ && umount {{ _destdir }}/sys/

    tar -czpf {{ _destdir }}.tar.gz {{ _destdir }}/
    rm -rf {{ _destdir }}/
  args:
    chdir: /var/lib/machines/
    creates: "{{ _destdir }}.tar.gz"
  vars:
    _destdir: "ubuntu-{{ item }}"
    _common_packages:
      - apt-transport-https
      - bash
      - curl
      - file
      - git
      - gnupg2
      - groff
      - htop
      - ifupdown
      - jq
      - mc
      - neovim
      - net-tools
      - openssh-client
      - openssh-server
      - systemd-container
      - wget
    _extra_packages:
      - augeas-lenses
      - augeas-tools
      - libaugeas-dev
      - python3-pip
      - ruby
    _include: "{{ (_common_packages + _extra_packages) | unique | join(',') }}"
  loop: "{{ ubuntu_codenames | unique }}"
